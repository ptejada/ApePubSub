/**
 * @author Pablo Tejada
 * @repo https://github.com/ptejada/ApePubSub
 * @version 1.6.6
 * Built on 2014-11-09 @ 10:16
 */
function randomString(c,a){for(var e=a||"0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",d=c||32,b="",f=0;f<d;f++)var h=Math.floor(Math.random()*e.length),b=b+e.substring(h,h+1);return b}
Function.prototype.bind||(Function.prototype.bind=function(c){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var a=Array.prototype.slice.call(arguments,1),e=this,d=function(){},b=function(){return e.apply(this instanceof d?this:c||window,a.concat(Array.prototype.slice.call(arguments)))};d.prototype=this.prototype;b.prototype=new d;return b});
function APS(c,a,e){this.option={poll:25E3,debug:!1,session:!0,connectionArgs:{},server:c,transport:["ws","lp"],secure:!1,eventPush:!1,addFrequency:!0,autoUpdate:!0};this.identifier="APS";this.version="1.6.6";this.state=0;this._events={};this.user={};this.pipes={};this.channels={};this.eQueue={};if(a)this.on(a);if(e)for(var d in e)this.option[d]=e[d];"Microsoft Internet Explorer"==navigator.appName&&(this.log="undefined"==typeof window.console?function(){}:function(){if(0!=this.option.debug){var b=
Array.prototype.slice.call(arguments);b.unshift("["+this.identifier+"]");window.console.log(b.join().replace(",",""))}});this.session=new APS.Session(this);return this}
APS.prototype.connect=function(c){var a=this.option.server,e={onmessage:this.onMessage.bind(this),onerror:function(b){this.trigger("dead",[b]);this.transport.close();this.session.destroy();this.state=0}.bind(this)};if(1==this.state)return this.log("Already Connected!");var d="CONNECT";c=this.option.connectionArgs=c||this.option.connectionArgs;var b=this.session.restore();this.session.saveFreq();if(1==this.option.session)if("object"==typeof b)c=b,d="RESTORE";else{if(0==this.trigger("connect"))return!1}else if(this.state=
0,0==this.trigger("connect"))return!1;this.option.addFrequency&&(a=this.session.getFreq()+"."+a);this.transport?0==this.transport.state&&(this.transport=new APS.Transport(a,e,this)):this.transport=new APS.Transport(a,e,this);c.version=this.version;this.sendCmd(d,c);return this};APS.prototype.reconnect=function(){if(0<this.state&&0<this.transport.state)return this.log("Client already connected!");this.channels={};this.connect()};
APS.prototype.trigger=function(c,a){c=c.toLowerCase();a instanceof Array||(a=[a]);if("_client"in this)for(var e in this._client._events[c])if(this._client._events[c].hasOwnProperty(e)&&(this.log("{{{ "+c+" }}}["+e+"] on client ",this._client),!1===this._client._events[c][e].apply(this,a)))return!1;for(e in this._events[c])if(this._events[c].hasOwnProperty(e)&&(this._client?this.log("{{{ "+c+" }}}["+e+"] ",this):this.log("{{{ "+c+" }}}["+e+"] on client ",this),!1===this._events[c][e].apply(this,a)))return!1;
return!0};APS.prototype.on=function(c,a){var e=[];if("string"==typeof c&&"function"==typeof a)e[c]=a;else if("object"==typeof c)e=c;else return this.log("Wrong parameters passed to on() method"),!1;for(var d in e)e.hasOwnProperty(d)&&(a=e[d],d=d.toLowerCase(),this._events[d]||(this._events[d]=[]),this._events[d].push(a));return this};APS.prototype.getPipe=function(c){return c in this.pipes?this.pipes[c]:!1};APS.prototype.send=function(c,a,e,d,b){this.sendCmd("Event",{event:a,data:e,sync:d},c,b);return this};
APS.prototype.sendCmd=function(c,a,e,d){var b={CONNECT:0,RESTORE:0};if(1==this.state||c in b){b={cmd:c,chl:this.transport.chl,freq:this.session.getFreq()};a&&(b.params=a);e&&(b.params.pipe="string"==typeof e?e:e.pubid);this.session.getID()&&(b.sessid=this.session.getID());this.log("<<<< ",c.toUpperCase()," >>>> ",b);"function"!=typeof d&&(d=function(){});c=[];try{c=JSON.stringify([b])}catch(f){this.log(f),this.log("Data Could not be strigify:",c),this.quit()}"pushed"!=this.transport.send(c,d,b)&&
this.transport.chl++}else this.on("ready",this.sendCmd.bind(this,c,a));return this};APS.prototype.poll=function(){0==this.transport.id&&(clearTimeout(this.poller),this.poller=setTimeout(this.check.bind(this),this.option.poll))};APS.prototype.check=function(c){if(0==this.transport.id||c)this.sendCmd("CHECK"),this.poll()};APS.prototype.quit=function(){this.sendCmd("QUIT");this.transport.close();this.trigger("dead");this.session.destroy();this.state=0};
APS.prototype.sub=function(c,a,e){if("object"==typeof a)if("object"==typeof c)for(var d in c)this.onChannel(c[d],a);else this.onChannel(c,a);if("function"==typeof e)if("object"==typeof c)for(d in c)this.onChannel(c[d],"joined",e);else this.onChannel(c,"joined",e);if(0==this.state)this.on("ready",this.sub.bind(this,c)),this.connect({user:this.user});else if("string"==typeof c)c=c.toLowerCase(),"object"!=typeof this.channels[c]?this.sendCmd("JOIN",{channels:[c]}):this.log("User already subscribed to ["+
c+"]");else{a=[];for(var b in c)"object"!=typeof this.channels[c[b].toLowerCase()]&&a.push(c[b]);0<a.length&&this.sendCmd("JOIN",{channels:a})}return this};APS.prototype.subscribe=APS.prototype.sub;APS.prototype.pub=function(c,a,e,d){var b=this.getChannel(c);b||32!=c.length||(b=this.getPipe(c));b?(c="string"==typeof a?"message":"data","message"==c&&(a=encodeURIComponent(a)),b.send(c,a,e,d)):this.log("NO Channel "+c)};APS.prototype.publish=APS.prototype.pub;
APS.prototype.getChannel=function(c){c=c.toLowerCase();return c in this.channels?this.channels[c]:!1};APS.prototype.onChannel=function(c,a,e){c=c.toLowerCase();if(c in this.channels)this.channels[c].on(a,e);else if("object"==typeof a){"object"!=typeof this.eQueue[c]&&(this.eQueue[c]=[]);for(var d in a)e=a[d],this.eQueue[c].push([d,e]),this.log("Adding ["+c+"] event '"+d+"' to queue")}else d={},d[a]=e,this.onChannel(c,d)};APS.prototype.unSub=function(c){""!=c&&this.getChannel(c).leave()};
APS.prototype.unSubscribe=APS.prototype.unSub;"Microsoft Internet Explorer"!=navigator.appName&&(APS.prototype.log=function(){if(this.option.debug){var c=Array.prototype.slice.call(arguments);c.unshift("["+this.identifier+"]");window.console.log.apply(console,c)}});
APS.prototype.onMessage=function(c){try{c=JSON.parse(c)}catch(a){c=c.replace(/\\'/g,"'");try{c=JSON.parse(c)}catch(e){return e.type="close",this.trigger("dead",[e]),this.transport.close()}}var d,b,f,h=!1,k=!0,g;for(g in c)if(c.hasOwnProperty(g))switch(d=c[g].raw,b=c[g].data,this.log(">>>> ",d," <<<< ",b),d){case "LOGIN":k=!1;this.state=0==this.state?1:this.state;this.session.save(b.sessid);this.trigger("login",[b.sessid]);break;case "IDENT":k=!1;h=!0;f=new APS.CUser(b.user,this);this.user=this.pipes[f.pubid]=
f;1==this.state&&this.trigger("ready");break;case "CHANNEL":d=new APS.Channel(b.pipe,this);this.pipes[d.pubid]=d;this.channels[d.name]=d;if(b=b.users)for(g=0;g<b.length;g++)d.addUser(b[g]);b=d.name.toLowerCase();if("object"==typeof this.eQueue[b]){b=this.eQueue[b];var l;for(g in b)b.hasOwnProperty(g)&&(f=b[g][0],l=b[g][1],d.on(f,l))}d.trigger("joined",[this.user,d]);this.trigger("newChannel",[d]);break;case "SYNC":f=this.user;d=this.pipes[b.chanid];"message"==b.event&&(b.data=decodeURIComponent(b.data));
d instanceof APS.User?f.trigger(b.event,[b.data,f,d]):d.trigger(b.event,[b.data,f,d]);break;case "EVENT-X":d=this.pipes[b.pipe.pubid];d.trigger(b.event,[b.data,d,d]);break;case "EVENT":f=this.pipes[b.from.pubid];"undefined"==typeof f&&b.from&&(this.pipes[b.from.pubid]=new APS.User(b.from,this),f=this.pipes[b.from.pubid]);d=this.pipes[b.pipe.pubid];d.pubid==f.pubid&&(d=this.user);"message"==b.event&&(b.data=decodeURIComponent(b.data));d.trigger(b.event,[b.data,f,d]);break;case "NOJOIN":this.trigger("notjoined",
[b]);break;case "JOIN":d=this.pipes[b.pipe.pubid];f=d.addUser(b.user);d.trigger("join",[f,d]);break;case "LEFT":d=this.pipes[b.pipe.pubid];f=this.pipes[b.user.pubid];delete d.users[b.user.pubid];d.trigger("left",[f,d]);break;case "UPDATE":this.option.autoUpdate&&(d=this.pipes[b.pipe.pubid],d._update(b.pipe.properties));break;case "SESSION_UPDATE":this.session._update(b);break;case "CLOSE":k=!1;break;case "ERR":k=!1;f=[b.code,b.value,b];switch(b.code){case "001":case "002":case "003":clearTimeout(this.poller);
this.trigger("dead",f);break;case "004":case "250":this.state=0;this.session.destroy(!0);this.option.session&&this.reconnect();break;default:this.check()}this.trigger("error",f);this.trigger("error"+b.code,f);break;default:f=[];for(g in b)b.hasOwnProperty(g)&&f.push(b[g]);this.trigger("raw"+d,f)}h&&1!=this.state&&(k=!0,this.state=1,!1!==this.trigger("restored")&&this.trigger("ready"));0==this.transport.id&&k&&1==this.transport.state&&this.check()};
APS.Transport=function(c,a,e){this.state=0;this.stack=[];this.callback=a;this.chl=0;var d=e.option.transport,b=Array.prototype.slice.call(arguments);if("object"==typeof d)for(var f in d){if(0!=APS.Transport[d[f]].apply(this,b))break}else"string"==typeof d&&APS.Transport[d].apply(this,b);var h=new function(){if("XMLHttpRequest"in window)return XMLHttpRequest;if("ActiveXObject"in window){var b=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.3.0","Msxml2.XMLHTTP","Microsoft.XMLHTTP"],a;for(a in b)try{return ActiveXObject(b[a])}catch(c){}}return!1};
this.request=function(b,a,c){var d=new h;d.addEventListener("load",function(){c(this.responseText)},!1);d.open("POST",b,!0);d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.send(a)};if(e.option.eventPush){var k=this.send.bind(this),g=function(b){a.onmessage(b)};this.send=function(b,a,d){if("Event"==d.cmd)return this.request(e.option.eventPush,"cmd="+b,g),"pushed";k.apply(this,[b,a])}}};
APS.Transport.ws=APS.Transport.wb=function(c,a,e){if("WebSocket"in window){this.id=6;this.loop=setInterval(e.check.bind(e,!0),3E4);var d=e.option.secure?"wss":"ws";try{var b=new WebSocket(d+"://"+c+"/6/")}catch(f){return a.onerror(f),!1}if(void 0===b.url)return!1;this.send=function(a,d){0<this.state?b.send(a):this.stack.push(a);"function"==typeof d&&d()}.bind(this);b.onerror=function(b){this.state=0;clearInterval(this.loop);a.onerror(b)}.bind(this);b.onopen=function(){this.state=2;for(var b=0;b<this.stack.length;b++)this.send(this.stack[b],
null,JSON.parse(this.stack[b])[0]);this.stack=[]}.bind(this);b.onmessage=function(b){a.onmessage(b.data)};b.onclose=function(b){clearInterval(this.loop);this.state=e.state=0;a.onerror(b)}.bind(this);this.close=function(){b.close();this.state=e.state=0}}else return e.log("No Websocket support"),!1};
APS.Transport.lp=function(c,a,e){function d(b){b.origin==h+"://"+c&&b.source===f.contentWindow&&(this.state=1,this.callback.onmessage(b.data))}function b(){this.state=1;for(var b=0;b<this.stack.length;b++)this.send(this.stack[b],null,JSON.parse(this.stack[b])[0]);this.stack=[]}this.id=0;var f=document.createElement("iframe"),h=e.option.secure?"https":"http";a=window.location.protocol+"//"+window.location.host;c=c.toLowerCase();f.style.display="none";document.body.appendChild(f);f.setAttribute("src",
h+"://"+c+'/?[{"cmd":"frame","params": {"origin":"'+a+'"}}]');"addEventListener"in window?(window.addEventListener("message",d.bind(this),0),f.addEventListener("load",b.bind(this),0)):window.attachEvent("onmessage",d.bind(this));this.send=function(b,a){0<this.state?(f.contentWindow.postMessage(b,h+"://"+c),this.state=2):this.stack.push(b);"function"==typeof a&&a()};this.close=function(){clearTimeout(e.poller);this.state=e.state=0}};
APS.User=function(c,a){Object.defineProperties(this,{_update:{value:function(d){if(d&&(d._rev=parseInt(d._rev),d._rev>this._rev))for(var b in d)this[b]!=d[b]&&(this[b]=d[b],a.trigger("user"+b+"Update",[d[b],this]),a.trigger("userUpdate",[b,d[b],this]))}},_rev:{value:null,configurable:!0,writable:!0},channels:{value:{},writable:!0},pubid:{value:c.pubid},pub:{value:a.pub.bind(a,c.pubid)},publish:{value:a.pub.bind(a,c.pubid)},send:{value:a.send.bind(a,c.pubid)}});for(var e in c.properties)this[e]=c.properties[e]};
APS.CUser=function(c,a){Object.defineProperties(this,{_update:{value:function(a,b){if(a&&(b||(a._rev=parseInt(a._rev)),a._rev>this._rev||b))for(var c in a)this[c]!=a[c]&&(this[c]=a[c],this.trigger("user"+c+"Update",[a[c],this]),this.trigger("userUpdate",[c,a[c],this]))}},update:{value:function(a,b){if("object"==typeof a)var c=a;else c={},c[a]=b;this._update(c,!0);this._client.sendCmd("userPropUpdate",c)}},_rev:{value:null,configurable:!0,writable:!0},_events:{value:{},writable:!0},_client:{value:a},
pubid:{value:c.pubid},channels:{value:{},writable:!0},on:{value:a.on.bind(this)},trigger:{value:a.trigger.bind(this)},log:{value:a.log.bind(a,"[CurrentUser]")}});for(var e in c.properties)this[e]=c.properties[e]};
APS.Channel=function(c,a){Object.defineProperties(this,{_update:{value:function(a){if(a&&(a._rev=parseInt(a._rev),a._rev>this._rev))for(var b in a)this[b]!=a[b]&&(this[b]=a[b],this.trigger("channel"+b+"Update",[a[b],this]),this.trigger("channelUpdate",[b,a[b],this]))}},leave:{value:function(){this.trigger("unsub",[a.user,this]);a.sendCmd("LEFT",{channel:c.properties.name});this.log("Unsubscribed");delete a.channels[this.name];delete a.eQueue[this.name]}},_rev:{value:null,configurable:!0,writable:!0},
_events:{value:{},writable:!0},_client:{value:a},pubid:{value:c.pubid},on:{value:a.on.bind(this)},trigger:{value:a.trigger.bind(this)},log:{value:a.log.bind(a,"[channel]","["+c.properties.name+"]")}});for(var e in c.properties)this[e]=c.properties[e];0!==this.name.indexOf("*")&&Object.defineProperties(this,{users:{value:{},writable:!0},addUser:{value:function(c){var b=a.getPipe(c.pubid);b?a.option.autoUpdate&&b._update(c.properties):(a.pipes[c.pubid]=new APS.User(c,a),b=a.pipes[c.pubid],b.channels[b.pubid]=
b);b.channels[this.name]=this;return this.users[c.pubid]=b}},send:{value:a.send.bind(a,this.pubid)},pub:{value:a.pub.bind(a,this.name)},publish:{value:a.pub.bind(a,this.name)}})};
APS.Session=function(c){this._client=c;this._data={};this.store={};this.getID=function(){return this._client.option.session?this.store.get("sid"):this._id};this.getFreq=function(){return this.store.get("freq")};this.getChl=function(){return this.store.get("chl")};this.save=function(a){this._client.option.session?this.store.set("sid",a):this._id=a};this.saveFreq=function(){var a=parseInt(this.store.get("freq")||0);this.store.set("freq",++a)};this.destroy=function(a){this.store.remove("sid");this.store.remove("chl");
a||this.store.set("freq",0);this._data={}};this.get=function(a){return this._data[a]};this.set=function(a,c){var d={};"object"==typeof a?d=a:d[a]=c;this._client.sendCmd("SESSION_SET",d);this._update(d)};this._update=function(a){for(var c in a)this._data[c]=a[c]};this.restore=function(){var a=this._client;this.store=new APS.Store(a.identifier+"_");this.store.get("freq")||this.store.set("freq","0");var c=this.store.get("sid");if("string"!=typeof c||32!==c.length)return!1;a.state=2;return{sid:c}}};
APS.Store=function(c){"undefined"==typeof c&&(c="");"Storage"in window?(this.get=function(a){a=c+a;return localStorage.getItem(a)},this.set=function(a,e){a=c+a;localStorage.setItem(a,e)},this.remove=function(a){a=c+a;localStorage.removeItem(a)}):(this.get=function(a){a=c+a;a+="=";for(var e=document.cookie.split(";"),d=0;d<e.length;d++){for(var b=e[d];" "==b.charAt(0);)b=b.substring(1,b.length);if(0==b.indexOf(a))return b.substring(a.length,b.length)}return null},this.set=function(a,e){a=c+a;document.cookie=
a+"="+e+"; path=/"},this.remove=function(a){a=c+a;var e=new Date;e.setTime(e.getTime()-1);e="; expires="+e.toGMTString();document.cookie=a+"= "+e+"; path=/"})};
