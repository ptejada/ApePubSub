/**
 * @author Pablo Tejada
 * @repo https://github.com/ptejada/ApePubSub
 * Built on 2013-03-23 @ 05:44
 */function randomString(a,f){var e=f||"0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var g=a||32;var d="";for(var c=0;c<g;c++){var b=Math.floor(Math.random()*e.length);d+=e.substring(b,b+1)}return d}if(!Function.prototype.bind){Function.prototype.bind=function(a){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var e=Array.prototype.slice.call(arguments,1),d=this,b=function(){},c=function(){return d.apply(this instanceof b?this:a||window,e.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;c.prototype=new b();return c}}function APS(d,c,a){this.option={poll:25000,debug:false,session:true,connectionArgs:{},server:d,transport:["wb","lp"],secure:false,eventPush:false,addFrequency:true};this.identifier="APS";this.version="1.5.2";this.state=0;this._events={};this.chl=0;this.user={};this.pipes={};this.channels={};this.eQueue={};if(!!c){this.on(c)}if(!!a){for(var b in a){this.option[b]=a[b]}}if(navigator.appName=="Microsoft Internet Explorer"){if(typeof window.console=="undefined"){this.log=function(){}}else{this.log=function(){if(this.option.debug==false){return}var e=Array.prototype.slice.call(arguments);e.unshift("["+this.identifier+"]");window.console.log(e.join().replace(",",""))}}}this.session._client=this;return this}APS.prototype.connect=function(c){var f=this.option.server;function b(g){this.trigger("dead",[g]);this.transport.close()}var a={onmessage:this.onMessage.bind(this),onerror:b.bind(this)};if(this.state==1){return this.log("Already Connected!")}var e="CONNECT";c=this.option.connectionArgs=c||this.option.connectionArgs;var d=this.session.restore();this.session.freq.change(parseInt(this.session.freq.value)+1);if(this.option.session==true){if(typeof d=="object"){c=d;e="RESTORE"}else{if(this.trigger("connect")==false){return false}}if(this.option.addFrequency){f=this.session.freq.value+"."+f}}else{this.state=0;if(this.trigger("connect")==false){return false}}if(!!this.transport){if(this.transport.state==0){this.transport=new APS.transport(f,a,this)}else{}}else{this.transport=new APS.transport(f,a,this)}this.sendCmd(e,c);return this};APS.prototype.reconnect=function(){if(this.state>0&&this.transport>0){return this.log("Client already connected!")}this.channels={};this.connect()};APS.prototype.trigger=function(c,a){c=c.toLowerCase();if(!(a instanceof Array)){a=[a]}if("_client" in this){for(var b in this._client._events[c]){if(this._client._events[c].hasOwnProperty(b)){this.log("{{{ "+c+" }}}["+b+"] on client ",this._client);if(this._client._events[c][b].apply(this,a)===false){return false}}}}for(var b in this._events[c]){if(this._events[c].hasOwnProperty(b)){if(!this._client){this.log("{{{ "+c+" }}}["+b+"] on client ",this)}else{this.log("{{{ "+c+" }}}["+b+"] ",this)}if(this._events[c][b].apply(this,a)===false){return false}}}return true};APS.prototype.on=function(c,b){var a=[];if(typeof c=="string"&&typeof b=="function"){a[c]=b}else{if(typeof c=="object"){a=c}else{return this}}for(var d in a){if(!a.hasOwnProperty(d)){continue}var b=a[d];d=d.toLowerCase();if(!this._events[d]){this._events[d]=[]}this._events[d].push(b)}return this};APS.prototype.getPipe=function(a){if(typeof a=="string"){return this.pipes[a]}else{return this.pipes[a.pubid]}};APS.prototype.send=function(b,a,d,c,e){this.sendCmd("Event",{event:a,data:d,sync:c},b,e)};APS.prototype.sendCmd=function(f,a,c,i){var h={CONNECT:0,RESTORE:0};if(this.state==1||f in h){var b={cmd:f,chl:this.chl,freq:this.session.freq.value};if(a){b.params=a}if(c){b.params.pipe=typeof c=="string"?c:c.pubid}if(this.session.id){b.sessid=this.session.id}this.log("<<<< ",f.toUpperCase()," >>>> ",b);if(typeof i!="function"){i=function(){}}var d=[];try{d=JSON.stringify([b])}catch(g){this.log(g);this.log(d)}if(this.transport.send(d,i,b)!="pushed"){this.session.saveChl()}}else{this.on("ready",this.sendCmd.bind(this,f,a))}return this};APS.prototype.poll=function(){if(this.transport.id==0){clearTimeout(this.poller);this.poller=setTimeout(this.check.bind(this),this.option.poll)}};APS.prototype.check=function(a){if(this.transport.id==0||!!a){this.sendCmd("CHECK");this.poll()}};APS.prototype.quit=function(){this.sendCmd("QUIT");this.transport.close();this.trigger("dead");this.session.destroy();this.state=0};APS.prototype.sub=function(c,b,f){if(typeof b=="object"){if(typeof c=="object"){for(var e in c){this.onChannel(c[e],b)}}else{this.onChannel(c,b)}}if(typeof f=="function"){if(typeof c=="object"){for(var e in c){this.onChannel(c[e],"joined",f)}}else{this.onChannel(c,"joined",f)}}if(this.state==0){this.on("ready",this.sub.bind(this,c));this.connect({user:this.user})}else{if(typeof c=="string"){c=c.toLowerCase();if(typeof this.channels[c]!="object"){this.sendCmd("JOIN",{channels:c})}}else{var d=[];for(var a in c){if(typeof this.channels[c[a].toLowerCase()]!="object"){d.push(c[a])}}if(d.length>0){this.sendCmd("JOIN",{channels:d})}}}return this};APS.prototype.pub=function(d,e,c,f){var b=this.getChannel(d);if(!b&&d.length==32){b=this.getPipe(d)}if(b){var a=typeof e=="string"?"message":"data";b.send(a,e,c,f)}else{this.log("NO Channel "+d)}};APS.prototype.getChannel=function(a){a=a.toLowerCase();if(a in this.channels){return this.channels[a]}return false};APS.prototype.onChannel=function(d,a,c){d=d.toLowerCase();if(d in this.channels){this.channels[d].on(a,c);return true}if(typeof a=="object"){if(typeof this.eQueue[d]!="object"){this.eQueue[d]=[]}for(var b in a){var c=a[b];this.eQueue[d].push([b,c]);this.log("Adding ["+d+"] event '"+b+"' to queue")}}else{var e=Object();e[a]=c;this.onChannel(d,e)}};APS.prototype.unSub=function(a){if(a==""){return}this.getChannel(a).leave();delete this.eQueue[a]};if(navigator.appName!="Microsoft Internet Explorer"){APS.prototype.log=function(){if(!this.option.debug){return}var a=Array.prototype.slice.call(arguments);a.unshift("["+this.identifier+"]");window.console.log.apply(console,a)}}APS.prototype.onMessage=function(h){try{h=JSON.parse(h)}catch(l){h=h.replace(/\\'/g,"'");try{h=JSON.parse(h)}catch(l){l.type="close";this.trigger("dead",[l]);return this.transport.close()}}var d,m,f,a=true;for(var j in h){if(!h.hasOwnProperty(j)){continue}d=h[j].raw;m=h[j].data;f=null;this.log(">>>> ",d," <<<< ",m);switch(d){case"LOGIN":a=false;this.state=this.state==0?1:this.state;this.session.id=m.sessid;this.trigger("login",[m.sessid]);break;case"IDENT":a=false;var g=new APS.cUser(m.user,this);this.pipes[g.pubid]=g;this.user=g;if(this.state==1){this.trigger("ready")}this.session.save();break;case"RESTORED":if(this.state==1){a=false;return}a=true;this.state=1;if(this.trigger("restored")!==false){this.trigger("ready")}break;case"CHANNEL":f=new APS.channel(m.pipe,this);this.pipes[f.pubid]=f;this.channels[f.name]=f;var p=m.users;if(!!p){var g;for(var j=0;j<p.length;j++){g=this.pipes[p[j].pubid];if(!g){this.pipes[p[j].pubid]=new APS.user(p[j],this);g=this.pipes[p[j].pubid]}g.channels[f.name]=f;f.users[g.pubid]=g;g.channels[g.pubid]=g}}var c=f.name.toLowerCase();if(typeof this.eQueue[c]=="object"){var k=this.eQueue[c];var o,n;for(var j in k){if(!k.hasOwnProperty(j)){continue}o=k[j][0];n=k[j][1];f.on(o,n)}}f.trigger("joined",[this.user,f]);this.trigger("newChannel",[f]);break;case"SYNC":var g=this.user;f=f=this.pipes[m.chanid];f.trigger(m.event,[m.data,g,f]);break;case"EVENT":var g=this.pipes[m.from.pubid];if(typeof g=="undefined"&&!!m.from){g=client.pipe[m.from.pubid]=new APS.user(m.from)}f=this.pipes[m.pipe.pubid];if(f.pubid==g.pubid){f=this.user}f.trigger(m.event,[m.data,g,f]);break;case"JOIN":var g=this.pipes[m.user.pubid];f=this.pipes[m.pipe.pubid];if(!g){this.pipes[m.user.pubid]=new APS.user(m.user,this);g=this.pipes[m.user.pubid]}g.channels[m.user.pubid]=g;f.addUser(g);f.update(m.pipe.properties);f.trigger("join",[g,f]);break;case"LEFT":f=this.pipes[m.pipe.pubid];var g=this.pipes[m.user.pubid];delete f.users[m.user.pubid];f.update(m.pipe.properties);f.trigger("left",[g,f]);break;case"ERR":a=false;var b=[m.code,m.value,m];switch(m.code){case"001":case"002":case"003":clearTimeout(this.poller);this.trigger("dead",b);break;case"004":case"250":this.state=0;this.session.destroy(true);if(this.option.session){this.reconnect()}break;default:this.check()}this.trigger("error",b);this.trigger("error"+m.code,b);break;default:var b=new Array();for(var j in m){if(!m.hasOwnProperty(j)){continue}b.push(m[j])}this.trigger(d,b)}}if(a&&this.transport.id==0&&this.transport.state==1){this.check()}};APS.transport=function(c,h,b){this.state=0;this.stack=[];this.callback=h;var k=b.option.transport;var f=Array.prototype.slice.call(arguments);if(typeof k=="object"){for(var i in k){var e=APS.transport[k[i]].apply(this,f);if(e!=false){break}}}else{if(typeof k=="string"){APS.transport[k].apply(this,f)}}function a(){if("XMLHttpRequest" in window){return XMLHttpRequest}if("ActiveXObject" in window){var n=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.3.0","Msxml2.XMLHTTP","Microsoft.XMLHTTP"];for(var l in n){try{return ActiveXObject(n[l])}catch(m){}}}return false}var g=new a();g=new g();this.request=function(n,l,m){g.onreadystatechange=function(){if(this.readyState==4){m(this.responseText)}};g.open("POST",n,true);g.setRequestHeader("Content-type","application/x-www-form-urlencoded");g.send(l)};if(!!b.option.eventPush){var d=this.send.bind(this);var j=function(l){h.onmessage(l)};this.send=function(n,l,m){if(m.cmd=="Event"){this.request(b.option.eventPush,"cmd="+n+"&from="+b.user.pubid,j);return"pushed"}else{d.apply(this,[n,l])}}}};APS.transport.wb=function(d,g,b){if("WebSocket" in window){this.id=6;this.loop=setInterval(b.check.bind(b,true),40000);var f=!!b.option.secure?"wss":"ws";try{var a=new WebSocket(f+"://"+d+"/6/")}catch(c){g.onerror(c);return false}this.send=function(h,e){if(this.state>0){a.send(h)}else{this.stack.push(h)}if(typeof e=="function"){e()}}.bind(this);a.onerror=function(h){this.state=0;clearInterval(this.loop);g.onerror(h)}.bind(this);a.onopen=function(){this.state=2;for(var e=0;e<this.stack.length;e++){this.send(this.stack[e],null,JSON.parse(this.stack[e])[0])}this.stack=[]}.bind(this);a.onmessage=function(e){g.onmessage(e.data)};a.onclose=function(h){clearInterval(this.loop);this.state=b.state=0;g.onerror(h)}.bind(this);this.close=function(){a.close();this.state=b.state=0}}else{b.log("No Websocket support");return false}};APS.transport.lp=function(server,callback,client){this.id=0;var frame=document.createElement("iframe");var protocol=!!client.option.secure?"https":"http";var origin=window.location.protocol+"//"+window.location.host;server=server.toLowerCase();with(frame.style){position="absolute";left=top="-10px";width=height="1px"}document.body.appendChild(frame);frame.setAttribute("src",protocol+"://"+server+'/?[{"cmd":"frame","params": {"origin":"'+origin+'"}}]');function recieveMessage(ev){if(ev.origin!=protocol+"://"+server){return}if(ev.source!==frame.contentWindow){return}this.state=1;this.callback.onmessage(ev.data)}function onLoad(){this.state=1;for(var i=0;i<this.stack.length;i++){this.send(this.stack[i],null,JSON.parse(this.stack[i])[0])}this.stack=[]}if("addEventListener" in window){window.addEventListener("message",recieveMessage.bind(this),0);frame.addEventListener("load",onLoad.bind(this),0)}else{window.attachEvent("onmessage",recieveMessage.bind(this))}this.send=function(str,cb){if(this.state>0){frame.contentWindow.postMessage(str,protocol+"://"+server);this.state=2}else{this.stack.push(str)}if(typeof cb=="function"){cb()}};this.close=function(){clearTimeout(client.poller);client.state=0}};APS.user=function(c,a){for(var b in c.properties){this[b]=c.properties[b]}this.pubid=c.pubid;this.channels={};this.pub=APS.prototype.pub.bind(a,this.pubid);this.send=APS.prototype.send.bind(a,this.pubid);this.update=function(e){for(var d in e){if(this[d]!=e[d]){this[d]=e[d]}}}};APS.cUser=function(c,a){for(var b in c.properties){this[b]=c.properties[b]}this.update=function(e){for(var d in e){if(this[d]!=e[d]){this[d]=e[d]}}};this._events={};this._client=a;this.pubid=c.pubid;this.channels={};this.on=a.on.bind(this);this.trigger=a.trigger.bind(this);this.log=a.log.bind(a,"[CurrentUser]")};APS.channel=function(c,a){for(var b in c.properties){this[b]=c.properties[b]}this._events={};this.pubid=c.pubid;this._client=a;this.update=function(e){for(var d in e){if(this[d]!=e[d]){this[d]=e[d]}}};this.leave=function(){this.trigger("unsub",[a.user,this]);a.sendCmd("LEFT",{channel:this.name});this.log("Unsubscribed");delete a.channels[this.name]};if(this.name.indexOf("*")!==0){this.users={};this.addUser=function(d){this.users[d.pubid]=d};this.send=APS.prototype.send.bind(a,this.pubid);this.pub=a.pub.bind(a,this.name)}this.on=a.on.bind(this);this.trigger=a.trigger.bind(this);this.log=a.log.bind(a,"[channel]","["+this.name+"]")};APS.prototype.session={id:"",chl:{},_client:{},cookie:{},freq:{},data:{},save:function(){if(!this._client.option.session){return}var b=this._client.user.pubid;var a=this._client;this.cookie.change(this.id+":"+b);this.saveChl()},saveChl:function(){if(!this._client.option.session){return}this._client.chl++;this.chl.change(this._client.chl)},destroy:function(a){if(!this._client.option.session){return}this.cookie.destroy();this.chl.destroy();if(!!!a){this.freq.change(0)}this._client.chl=0;this.id=null;this.properties={}},get:function(a){return this.data[a]},set:function(a,b){this.data[a]=b},restore:function(){var a=this._client;this.chl=new APS.cookie(a.identifier+"_chl");this.cookie=new APS.cookie(a.identifier+"_session");this.freq=new APS.cookie(a.identifier+"_frequency");a.chl=this.chl.value||0;if(!this.freq.value){this.freq.change("0")}if(typeof this.cookie.value=="string"&&this.cookie.value.length>=32){var b=this.cookie.value.split(":");this.id=b[0]}else{return false}a.state=2;return{sid:b[0],pubid:b[1]}}};APS.cookie=function(a,c,d){this.change=function(h,i){var g=this.name;if(i){var f=new Date();f.setTime(f.getTime()+(i*24*60*60*1000));var e="; expires="+f.toGMTString()}else{var e=""}document.cookie=g+"="+h+e+"; path="+this.path;this.value=h};this.read=function(f){var h=f+"=";var e=document.cookie.split(";");for(var g=0;g<e.length;g++){var j=e[g];while(j.charAt(0)==" "){j=j.substring(1,j.length)}if(j.indexOf(h)==0){return j.substring(h.length,j.length)}}return null};this.destroy=function(){this.change("",-1)};this.path="/";var b=this.read(a);this.name=a;if(b&&typeof c=="undefined"){this.value=b}else{this.value=c||"";this.change(this.value,d)}return this};